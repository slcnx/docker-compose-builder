<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raft 网络分区下的强一致性保证</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
            font-size: 32px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        /* CAP说明 */
        .cap-explanation {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .cap-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }

        .cap-card.chosen {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .cap-card.sacrificed {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .cap-card h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .cap-card p {
            font-size: 14px;
            opacity: 0.95;
            line-height: 1.6;
        }

        /* 场景控制 */
        .scenario-control {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .scenario-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .scenario-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .scenario-btn.active {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        /* 可视化区域 */
        .visualization {
            position: relative;
            background: #f8f9ff;
            border-radius: 15px;
            padding: 60px 40px;
            min-height: 500px;
            margin-bottom: 30px;
        }

        /* 分区线 */
        .partition-line {
            position: absolute;
            left: 50%;
            top: 10%;
            bottom: 10%;
            width: 4px;
            background: repeating-linear-gradient(
                0deg,
                #e53e3e,
                #e53e3e 10px,
                transparent 10px,
                transparent 20px
            );
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 5;
        }

        .partition-line.show {
            opacity: 1;
        }

        .partition-label {
            position: absolute;
            left: 50%;
            top: 5%;
            transform: translateX(-50%);
            background: #e53e3e;
            color: white;
            padding: 8px 20px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 6;
        }

        .partition-label.show {
            opacity: 1;
        }

        /* 分区区域标识 */
        .partition-zone {
            position: absolute;
            top: 15%;
            bottom: 15%;
            border: 3px dashed transparent;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.5s;
        }

        .partition-zone.minority {
            left: 5%;
            width: 35%;
            border-color: #e53e3e;
            background: rgba(229, 62, 62, 0.05);
        }

        .partition-zone.majority {
            right: 5%;
            width: 45%;
            border-color: #48bb78;
            background: rgba(72, 187, 120, 0.05);
        }

        .partition-zone.hidden {
            border-color: transparent;
            background: transparent;
        }

        .zone-label {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
            font-size: 14px;
            padding: 5px 15px;
            border-radius: 5px;
        }

        .zone-label.minority {
            background: #e53e3e;
            color: white;
        }

        .zone-label.majority {
            background: #48bb78;
            color: white;
        }

        /* Raft节点 */
        .raft-node {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            transition: all 0.5s;
        }

        .node-1 { left: 15%; top: 30%; }
        .node-2 { left: 15%; bottom: 30%; }
        .node-3 { left: 50%; top: 20%; transform: translateX(-50%); }
        .node-4 { right: 20%; top: 35%; }
        .node-5 { right: 20%; bottom: 35%; }

        .node-card {
            background: white;
            border: 4px solid #667eea;
            border-radius: 12px;
            padding: 20px 25px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-width: 130px;
            transition: all 0.3s;
        }

        .node-card.leader {
            border-color: #f5c518;
            background: linear-gradient(135deg, #fff9e6, #ffffff);
            box-shadow: 0 0 30px rgba(245, 197, 24, 0.5);
        }

        .node-card.follower {
            border-color: #48bb78;
        }

        .node-card.unavailable {
            border-color: #e53e3e;
            opacity: 0.6;
            background: #fff5f5;
        }

        .node-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .node-role {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 5px;
        }

        .role-leader {
            background: #f5c518;
            color: #333;
        }

        .role-follower {
            background: #d4edda;
            color: #155724;
        }

        .role-unavailable {
            background: #f8d7da;
            color: #721c24;
        }

        .crown {
            font-size: 28px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* 客户端 */
        .client {
            position: absolute;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.5s;
        }

        .client-left {
            left: 5%;
            top: 50%;
            transform: translateY(-50%);
        }

        .client-right {
            right: 5%;
            top: 50%;
            transform: translateY(-50%);
        }

        /* 请求箭头 */
        .request-arrow {
            position: absolute;
            height: 3px;
            background: #667eea;
            opacity: 0;
            transition: all 0.5s;
            z-index: 3;
        }

        .request-arrow.show {
            opacity: 1;
        }

        .request-arrow::after {
            content: '';
            position: absolute;
            right: -10px;
            top: -4px;
            width: 0;
            height: 0;
            border-left: 10px solid #667eea;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
        }

        .request-arrow.success {
            background: #48bb78;
        }

        .request-arrow.success::after {
            border-left-color: #48bb78;
        }

        .request-arrow.failed {
            background: #e53e3e;
        }

        .request-arrow.failed::after {
            border-left-color: #e53e3e;
        }

        /* 响应文字 */
        .response-text {
            position: absolute;
            background: white;
            border: 2px solid;
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            opacity: 0;
            transition: all 0.5s;
            z-index: 4;
        }

        .response-text.show {
            opacity: 1;
        }

        .response-text.success {
            border-color: #48bb78;
            color: #48bb78;
        }

        .response-text.failed {
            border-color: #e53e3e;
            color: #e53e3e;
        }

        /* 说明框 */
        .explanation {
            background: #e8f4f8;
            border-left: 5px solid #667eea;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .explanation h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .explanation p {
            color: #333;
            line-height: 1.8;
            font-size: 15px;
            margin-bottom: 10px;
        }

        .explanation .highlight {
            background: #fff3cd;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        /* 对比表格 */
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .comparison-item {
            background: white;
            border: 3px solid;
            border-radius: 12px;
            padding: 20px;
        }

        .comparison-item.majority {
            border-color: #48bb78;
        }

        .comparison-item.minority {
            border-color: #e53e3e;
        }

        .comparison-item h4 {
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }

        .comparison-item ul {
            list-style: none;
            padding: 0;
        }

        .comparison-item li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            line-height: 1.6;
        }

        .comparison-item li::before {
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .comparison-item.majority li::before {
            content: '✓';
            color: #48bb78;
        }

        .comparison-item.minority li::before {
            content: '✗';
            color: #e53e3e;
        }

        /* 关键点 */
        .key-points {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 20px;
            border-radius: 8px;
        }

        .key-points h3 {
            color: #856404;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .key-points ul {
            list-style: none;
            padding: 0;
        }

        .key-points li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
            color: #856404;
            line-height: 1.6;
        }

        .key-points li::before {
            content: '→';
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .key-points strong {
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Raft：网络分区下如何保证强一致性？</h1>
        <p class="subtitle">CAP理论：Raft选择CP（一致性+分区容错），牺牲可用性来保证强一致</p>

        <!-- CAP说明 -->
        <div class="cap-explanation">
            <div class="cap-card chosen">
                <h3>C - 一致性 ✅</h3>
                <p>所有节点在同一时间看到相同的数据<br><strong>Raft保证强一致性</strong></p>
            </div>
            <div class="cap-card sacrificed">
                <h3>A - 可用性 ❌</h3>
                <p>每个请求都能得到响应<br><strong>分区时少数派不可用</strong></p>
            </div>
            <div class="cap-card chosen">
                <h3>P - 分区容错 ✅</h3>
                <p>网络分区时系统继续运行<br><strong>多数派继续工作</strong></p>
            </div>
        </div>

        <!-- 场景控制 -->
        <div class="scenario-control">
            <button class="scenario-btn active" onclick="showScenario('normal')">正常情况</button>
            <button class="scenario-btn" onclick="showScenario('partition')">发生分区</button>
            <button class="scenario-btn" onclick="showScenario('write-majority')">写入多数派</button>
            <button class="scenario-btn" onclick="showScenario('write-minority')">写入少数派</button>
            <button class="scenario-btn" onclick="showScenario('recovery')">分区恢复</button>
        </div>

        <!-- 可视化区域 -->
        <div class="visualization" id="viz">
            <!-- 分区线 -->
            <div class="partition-line" id="partition-line"></div>
            <div class="partition-label" id="partition-label">⚠️ 网络分区</div>

            <!-- 分区区域 -->
            <div class="partition-zone minority hidden" id="zone-minority">
                <div class="zone-label minority">少数派（2节点）<br>不可用</div>
            </div>
            <div class="partition-zone majority hidden" id="zone-majority">
                <div class="zone-label majority">多数派（3节点）<br>可用</div>
            </div>

            <!-- Raft节点 -->
            <div class="raft-node node-1" id="node1">
                <div class="node-card follower">
                    <div class="node-title">Node 1</div>
                    <div class="node-role role-follower">Follower</div>
                </div>
            </div>

            <div class="raft-node node-2" id="node2">
                <div class="node-card follower">
                    <div class="node-title">Node 2</div>
                    <div class="node-role role-follower">Follower</div>
                </div>
            </div>

            <div class="raft-node node-3" id="node3">
                <div class="node-card leader">
                    <div class="crown">👑</div>
                    <div class="node-title">Node 3</div>
                    <div class="node-role role-leader">Leader</div>
                </div>
            </div>

            <div class="raft-node node-4" id="node4">
                <div class="node-card follower">
                    <div class="node-title">Node 4</div>
                    <div class="node-role role-follower">Follower</div>
                </div>
            </div>

            <div class="raft-node node-5" id="node5">
                <div class="node-card follower">
                    <div class="node-title">Node 5</div>
                    <div class="node-role role-follower">Follower</div>
                </div>
            </div>

            <!-- 客户端请求箭头和响应 -->
            <div class="request-arrow" id="arrow-left"></div>
            <div class="request-arrow" id="arrow-right"></div>
            <div class="response-text" id="response-left"></div>
            <div class="response-text" id="response-right"></div>
        </div>

        <!-- 场景说明 -->
        <div class="explanation" id="explanation">
            <h3>场景：正常情况（5节点集群）</h3>
            <p>
                • 集群有5个节点，需要 <span class="highlight">至少3个节点（5/2+1）</span> 确认才能提交写入<br>
                • Node 3 是 Leader，负责处理所有写请求<br>
                • 所有节点可以正常通信，数据强一致
            </p>
        </div>

        <!-- 对比说明 -->
        <div class="comparison" id="comparison" style="display: none;">
            <div class="comparison-item majority">
                <h4>✅ 多数派分区（3节点）</h4>
                <ul>
                    <li>拥有3个节点，满足多数派 (3 ≥ 5/2+1)</li>
                    <li>可以选出Leader（Node 3）</li>
                    <li>可以处理写请求（获得3个确认）</li>
                    <li>保证强一致性：写入必须多数确认</li>
                    <li><strong>分区继续对外提供服务</strong></li>
                </ul>
            </div>

            <div class="comparison-item minority">
                <h4>❌ 少数派分区（2节点）</h4>
                <ul>
                    <li>只有2个节点，不满足多数派 (2 < 5/2+1)</li>
                    <li>无法选出Leader（得不到多数票）</li>
                    <li>拒绝所有写请求</li>
                    <li>避免脑裂：防止数据不一致</li>
                    <li><strong>分区停止对外提供服务</strong></li>
                </ul>
            </div>
        </div>

        <!-- 关键点 -->
        <div class="key-points">
            <h3>🔑 Raft如何在分区时保证强一致性？</h3>
            <ul>
                <li><strong>多数派原则</strong>：任何操作必须获得多数节点（n/2+1）确认才能生效</li>
                <li><strong>Leader只在多数派</strong>：只有拥有多数节点的分区才能选出Leader</li>
                <li><strong>少数派拒绝服务</strong>：少数派无法选出Leader，拒绝所有写请求，避免脑裂</li>
                <li><strong>牺牲可用性</strong>：少数派节点暂时不可用，但保证了数据一致性</li>
                <li><strong>分区恢复后同步</strong>：网络恢复后，少数派节点从Leader同步最新数据</li>
                <li><strong>强一致保证</strong>：任何时刻，只有一个有效的Leader，所有提交的数据都经过多数派确认</li>
            </ul>
        </div>
    </div>

    <script>
        function showScenario(scenario) {
            // 更新按钮状态
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 获取元素
            const partitionLine = document.getElementById('partition-line');
            const partitionLabel = document.getElementById('partition-label');
            const zoneMinority = document.getElementById('zone-minority');
            const zoneMajority = document.getElementById('zone-majority');
            const comparison = document.getElementById('comparison');
            const explanation = document.getElementById('explanation');

            // 清除所有箭头和响应
            document.querySelectorAll('.request-arrow, .response-text').forEach(el => {
                el.classList.remove('show', 'success', 'failed');
                el.style.cssText = '';
            });

            // 场景配置
            const scenarios = {
                normal: {
                    title: '场景：正常情况（5节点集群）',
                    description: '• 集群有5个节点，需要 <span class="highlight">至少3个节点（5/2+1）</span> 确认才能提交写入<br>• Node 3 是 Leader，负责处理所有写请求<br>• 所有节点可以正常通信，数据强一致',
                    partition: false,
                    comparison: false,
                    nodes: {
                        1: { role: 'follower', available: true },
                        2: { role: 'follower', available: true },
                        3: { role: 'leader', available: true },
                        4: { role: 'follower', available: true },
                        5: { role: 'follower', available: true }
                    }
                },
                partition: {
                    title: '场景：发生网络分区（2节点 vs 3节点）',
                    description: '• 网络故障导致集群分成两部分：<span class="highlight">左侧2节点</span> vs <span class="highlight">右侧3节点</span><br>• 左侧少数派（2节点）：无法选出Leader，<span class="highlight">停止服务</span><br>• 右侧多数派（3节点）：重新选举Node 3为Leader，<span class="highlight">继续服务</span><br>• <strong>关键：只有多数派能工作，保证不会出现两个Leader（脑裂）</strong>',
                    partition: true,
                    comparison: true,
                    nodes: {
                        1: { role: 'unavailable', available: false },
                        2: { role: 'unavailable', available: false },
                        3: { role: 'leader', available: true },
                        4: { role: 'follower', available: true },
                        5: { role: 'follower', available: true }
                    }
                },
                'write-majority': {
                    title: '场景：客户端写入多数派（成功）',
                    description: '• 客户端向多数派（右侧）发送写请求<br>• Leader（Node 3）接收请求，复制到多数派节点（Node 4, 5）<br>• 获得 <span class="highlight">3个节点确认（3 ≥ 5/2+1）</span>，满足多数派条件<br>• <strong>写入成功提交，返回成功响应，数据保证强一致</strong>',
                    partition: true,
                    comparison: true,
                    nodes: {
                        1: { role: 'unavailable', available: false },
                        2: { role: 'unavailable', available: false },
                        3: { role: 'leader', available: true },
                        4: { role: 'follower', available: true },
                        5: { role: 'follower', available: true }
                    },
                    arrows: {
                        right: { show: true, success: true, left: '70%', top: '50%', width: '15%' }
                    },
                    responses: {
                        right: { show: true, success: true, text: '✓ 写入成功', right: '10%', top: '55%' }
                    }
                },
                'write-minority': {
                    title: '场景：客户端写入少数派（失败）',
                    description: '• 客户端向少数派（左侧）发送写请求<br>• 少数派只有2个节点，<span class="highlight">无法选出Leader</span><br>• 无法获得多数派确认（2 < 5/2+1）<br>• <strong>拒绝写入请求，返回失败响应</strong><br>• <span class="highlight">关键：宁可拒绝服务（牺牲可用性），也不接受可能不一致的数据</span>',
                    partition: true,
                    comparison: true,
                    nodes: {
                        1: { role: 'unavailable', available: false },
                        2: { role: 'unavailable', available: false },
                        3: { role: 'leader', available: true },
                        4: { role: 'follower', available: true },
                        5: { role: 'follower', available: true }
                    },
                    arrows: {
                        left: { show: true, success: false, left: '5%', top: '50%', width: '15%' }
                    },
                    responses: {
                        left: { show: true, success: false, text: '✗ 无Leader，拒绝写入', left: '8%', top: '45%' }
                    }
                },
                recovery: {
                    title: '场景：网络分区恢复',
                    description: '• 网络故障修复，两个分区可以重新通信<br>• 少数派节点（Node 1, 2）发现多数派的Leader（Node 3）<br>• 少数派节点从Leader同步最新数据，<span class="highlight">追赶进度</span><br>• 集群恢复到5节点正常状态，所有节点数据一致<br>• <strong>整个过程保证强一致性：少数派从未接受过写入，同步后数据完全一致</strong>',
                    partition: false,
                    comparison: false,
                    nodes: {
                        1: { role: 'follower', available: true },
                        2: { role: 'follower', available: true },
                        3: { role: 'leader', available: true },
                        4: { role: 'follower', available: true },
                        5: { role: 'follower', available: true }
                    }
                }
            };

            const config = scenarios[scenario];

            // 更新说明
            explanation.querySelector('h3').textContent = config.title;
            explanation.querySelector('p').innerHTML = config.description;

            // 显示/隐藏分区线
            if (config.partition) {
                partitionLine.classList.add('show');
                partitionLabel.classList.add('show');
                zoneMinority.classList.remove('hidden');
                zoneMajority.classList.remove('hidden');
            } else {
                partitionLine.classList.remove('show');
                partitionLabel.classList.remove('show');
                zoneMinority.classList.add('hidden');
                zoneMajority.classList.add('hidden');
            }

            // 显示/隐藏对比
            comparison.style.display = config.comparison ? 'grid' : 'none';

            // 更新节点状态
            for (let nodeId in config.nodes) {
                const node = document.getElementById('node' + nodeId);
                const card = node.querySelector('.node-card');
                const roleSpan = node.querySelector('.node-role');
                const nodeConfig = config.nodes[nodeId];

                // 清除所有状态
                card.classList.remove('leader', 'follower', 'unavailable');
                roleSpan.className = 'node-role';

                // 移除旧皇冠
                const oldCrown = node.querySelector('.crown');
                if (oldCrown) oldCrown.remove();

                // 设置新状态
                if (nodeConfig.role === 'leader') {
                    card.classList.add('leader');
                    roleSpan.classList.add('role-leader');
                    roleSpan.textContent = 'Leader';
                    // 添加皇冠
                    const crown = document.createElement('div');
                    crown.className = 'crown';
                    crown.textContent = '👑';
                    card.insertBefore(crown, card.firstChild);
                } else if (nodeConfig.role === 'follower') {
                    card.classList.add('follower');
                    roleSpan.classList.add('role-follower');
                    roleSpan.textContent = 'Follower';
                } else {
                    card.classList.add('unavailable');
                    roleSpan.classList.add('role-unavailable');
                    roleSpan.textContent = '不可用';
                }
            }

            // 显示箭头和响应
            if (config.arrows) {
                for (let arrowId in config.arrows) {
                    const arrowConfig = config.arrows[arrowId];
                    const arrow = document.getElementById('arrow-' + arrowId);
                    arrow.classList.add('show');
                    arrow.classList.add(arrowConfig.success ? 'success' : 'failed');
                    arrow.style.left = arrowConfig.left;
                    arrow.style.top = arrowConfig.top;
                    arrow.style.width = arrowConfig.width;
                }
            }

            if (config.responses) {
                for (let responseId in config.responses) {
                    const responseConfig = config.responses[responseId];
                    const response = document.getElementById('response-' + responseId);
                    response.classList.add('show');
                    response.classList.add(responseConfig.success ? 'success' : 'failed');
                    response.textContent = responseConfig.text;
                    if (responseConfig.left) response.style.left = responseConfig.left;
                    if (responseConfig.right) response.style.right = responseConfig.right;
                    response.style.top = responseConfig.top;
                }
            }
        }

        // 初始化
        showScenario('normal');
    </script>
</body>
</html>